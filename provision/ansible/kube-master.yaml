---
- name: Preparacao base (todos os hosts)
  hosts: all
  become: yes
  become_user: root
  become_method: sudo

  tasks:
    - name: Garantindo /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: "{{ item }}"
        state: present
      loop:
        - "172.16.1.100 kube-master"
        - "172.16.1.101 kube-node1"
        - "172.16.1.102 kube-node2"
        - "172.16.1.103 kube-infra"
        - "172.16.1.202 docker-registry"

    - name: Remove swap do arquivo /etc/fstab
      mount:
        name: "{{ item }}"
        fstype: swap
        state: absent
      loop:
        - swap
        - none

    - name: Desativa o swap
      command: swapoff -a
      when: ansible_swaptotal_mb | int > 0

    - name: Cria o arquivo containerd.conf
      file:
        path: /etc/modules-load.d/containerd.conf
        state: touch
        mode: '0644'

    - name: Configurando modulos
      lineinfile:
        path: /etc/modules-load.d/containerd.conf
        line: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: Carregando modulos
      shell: modprobe overlay && modprobe br_netfilter
      args:
        executable: /bin/bash

    - name: Cria o arquivo kubernetes.conf (sysctl)
      file:
        path: /etc/sysctl.d/kubernetes.conf
        state: touch
        mode: '0644'

    - name: Configurando sysctl
      lineinfile:
        path: /etc/sysctl.d/kubernetes.conf
        line: "{{ item }}"
        state: present
      loop:
        - "net.bridge.bridge-nf-call-ip6tables = 1"
        - "net.bridge.bridge-nf-call-iptables = 1"
        - "net.ipv4.ip_forward = 1"

    - name: Aplicando sysctl
      shell: sysctl --system
      args:
        executable: /bin/bash

    - name: Adiciona usuario suporte
      user:
        name: suporte
        shell: /bin/bash
        password: "$1$QbUARykG$p2nthVG8AkDvabKPHwboa1"

    - name: Instala pacotes base
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg2
          - software-properties-common
          - mysql-client
          - nfs-common
          - snapd
          - git
          - vim
        state: present
        update_cache: yes

    - name: Clona repositório com os arquivos do curso para a HOME do usuario suporte
      git:
        repo: "https://github.com/4linux/541-kubernetes.git"
        dest: /home/suporte/541

    - name: Adiciona uma chave de assinatura apt para o Docker
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Adiciona repositorio apt para versao estavel (Docker)
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"
        state: present

    - name: Instala o Containerd
      apt:
        name: containerd.io
        state: present
        update_cache: yes

    - name: Criar conf default do Containerd
      shell: containerd config default | tee /etc/containerd/config.toml >/dev/null 2>&1
      args:
        executable: /bin/bash

    - name: Ativa o Systemd no arquivo config.toml
      replace:
        path: /etc/containerd/config.toml
        regexp: "SystemdCgroup = false"
        replace: "SystemdCgroup = true"

    - name: Ativa o uso de plugins no arquivo config.toml
      replace:
        path: /etc/containerd/config.toml
        regexp: "^disabled_plugins ="
        replace: "#disabled_plugins ="

    - name: Reinicia o containerd
      service:
        name: containerd
        state: restarted

    - name: Criar diretório /etc/apt/keyrings para apt do Kubernetes
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Adicione o repositório apt do Kubernetes ao sources.list
      lineinfile:
        path: /etc/apt/sources.list.d/kubernetes.list
        line: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /"
        create: yes
        state: present

    - name: Importar chave GPG para o sistema
      shell: "curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg"
      args:
        executable: /bin/bash

    - name: Instala os pacotes do Kubernetes
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
        update_cache: yes


- name: Inicializacao do cluster + Calico (apenas no master)
  hosts: kube-master
  become: yes
  become_user: root
  become_method: sudo

  vars:
    # mantenha CRDs e Operator na MESMA versão
    calico_version: "v3.28.5"
    calico_base_url: "https://raw.githubusercontent.com/projectcalico/calico/{{ calico_version }}/manifests"

  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

  tasks:
    - name: Inicializa o cluster Kubernetes via kubeadm
      shell: >
        kubeadm init
        --apiserver-advertise-address=172.16.1.100
        --pod-network-cidr=192.168.0.0/16
        --ignore-preflight-errors=all
        > /opt/init_cluster
      args:
        executable: /bin/bash
        creates: /opt/init_cluster

    - name: Cria o diretório .kube para o usuário vagrant
      file:
        path: /home/vagrant/.kube
        state: directory
        owner: vagrant
        group: vagrant
        mode: "0755"

    - name: Configura o kubeconfig para o usuario vagrant
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/vagrant/.kube/config
        remote_src: yes

    - name: Definir permissao de acesso ao arquivo config (vagrant)
      file:
        path: /home/vagrant/.kube/config
        owner: vagrant
        group: vagrant
        mode: "0644"

    - name: Cria o diretório .kube para o usuário suporte
      file:
        path: /home/suporte/.kube
        state: directory
        owner: suporte
        group: suporte
        mode: "0755"

    - name: Configura o kubeconfig para o usuario suporte
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/suporte/.kube/config
        remote_src: yes

    - name: Definir permissao de acesso ao arquivo config (suporte)
      file:
        path: /home/suporte/.kube/config
        owner: suporte
        group: suporte
        mode: "0644"

    - name: Aguarda API do Kubernetes responder
      command: kubectl get nodes
      register: k8s_api
      until: k8s_api.rc == 0
      retries: 20
      delay: 3
      changed_when: false

    # ===== FIX: aplicar CRDs com Server-Side Apply para não estourar annotations =====

    - name: Baixa operator-crds.yaml (Calico)
      get_url:
        url: "{{ calico_base_url }}/operator-crds.yaml"
        dest: /home/vagrant/operator-crds.yaml
        mode: "0644"

    - name: Baixa tigera-operator.yaml (Calico)
      get_url:
        url: "{{ calico_base_url }}/tigera-operator.yaml"
        dest: /home/vagrant/tigera-operator.yaml
        mode: "0644"

    - name: Aplica CRDs do Tigera/Calico (server-side apply)
      command:
        argv:
          - kubectl
          - apply
          - --server-side
          - --force-conflicts
          - -f
          - /home/vagrant/operator-crds.yaml

    - name: Instala o Tigera Operator (server-side apply)
      command:
        argv:
          - kubectl
          - apply
          - --server-side
          - --force-conflicts
          - -f
          - /home/vagrant/tigera-operator.yaml

    - name: Aguarda tigera-operator Available
      command:
        argv:
          - kubectl
          - -n
          - tigera-operator
          - wait
          - --for=condition=Available
          - --timeout=180s
          - deployment/tigera-operator
      register: wait_operator
      changed_when: false
      failed_when: wait_operator.rc != 0

    - name: Aguarda CRDs do Tigera ficarem Established
      vars:
        crds:
          - installations.operator.tigera.io
          - apiservers.operator.tigera.io
      loop: "{{ crds }}"
      loop_control:
        loop_var: crd
      command:
        argv:
          - kubectl
          - wait
          - --for=condition=Established
          - --timeout=180s
          - "crd/{{ crd }}"
      register: wait_crds
      until: wait_crds.rc == 0
      retries: 10
      delay: 6
      changed_when: false

    - name: Copia seu custom-resources.yaml
      copy:
        src: files/custom-resources.yaml
        dest: /home/vagrant/custom-resources.yaml
        owner: vagrant
        group: vagrant
        mode: "0644"

    - name: Instala a rede calico no cluster (custom-resources.yaml)
      command:
        argv:
          - kubectl
          - apply
          - -f
          - /home/vagrant/custom-resources.yaml

    - name: Permite que o master execute Pods como Worker
      shell: kubectl taint nodes kube-master node-role.kubernetes.io/control-plane- || true
      args:
        executable: /bin/bash
      changed_when: false

    - name: Gera o comando para o join de novos nodes
      command: kubeadm token create --print-join-command
      register: join_command

    - name: Copia o comando do join no arquivo local (na maquina que roda o Ansible)
      delegate_to: localhost
      copy:
        content: "{{ join_command.stdout_lines[0] }}\n"
        dest: "./join-command"
      run_once: true
